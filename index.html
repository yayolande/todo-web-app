<script src='./assets/vue.global.js'></script>
<script src='./assets/vue-router.global.js'></script>
<link rel="stylesheet" href="assets/bulma.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script src="https://unpkg.com/vue-demi"></script>
<script src="https://unpkg.com/pinia"></script>

<style>
  html {
    background-color: #ECF0F3;
  }

  body {
    margin: 0;
    padding: 0;
    min-height: 100%;
    background-color: #ECF0F3;
    padding: 0 .6rem;
    // background-color: #C4CFCF;
  }

  navbar {
    border-bottom: solid 1px #E1E4F1;
  }

  .box-shadow {
    box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.15);
  }

  hr {
    background-color: #ccc;
  }

  .todo-task-completed {
    // color: #ccc !important;
    // border-color: #ddd !important;
    opacity: .4;
  }

  .todo-task {
    border: 1px solid rgba(0, 0, 0, 0.41);
    border-radius: 7px;
    padding: 10px 35px;
    padding-right: 10px;
    margin: 30px 100px;
    display: flex;
    align-items: center;
  }

  .todo-content {
    flex: 1;
  }

  .todo-right {
    // display: none
  }

  .todo-task:hover .todo-right {
    display: block;
  }

  .todo-right>button {
    margin-left: 5px;
    background-color: inherit;
    border: 0;
  }

  .todo-right>button.trash:hover {
    background-color: #FFDCDC;
  }

  .todo-right>button.trash:active {
    box-shadow: 1px 2px 4px #FFDCDC;
  }

  .todo-right>button.completed:hover {
    background-color: #DCEFDC;
  }

  .todo-right>button.completed:active {
    box-shadow: 1px 2px 4px #DCEFDC;
  }


  .todo-title {
    font-size: 20px;
    font-weight: 700;
  }

  .todo-subtitle {
    font-style: italic;
  }
</style>


<nav class='navbar mb-6 py-3'>
  <div class='container is-size-5'>
    <div class='navbar-brand ml-1'>
      <img src='./assets/bulma-logo.png' width='112' height='28'>
    </div>
    <div class='navbar-menu'>
      <div class='navbar-start'>
        <a class='navbar-item'>Home</a>
        <a class='navbar-item'>Home</a>
        <a class='navbar-item'>Home</a>
      </div>
      <div class='navbar-end'>
        <a class='navbar-item'>Login</a>
        <a class='navbar-item'>Login</a>
        <a class='navbar-item'>Login</a>
      </div>
    </div>
  </div>
</nav>

<p class='block'>
  <router-link to='/login'>Go to Login Page</router-link>
  <br>
  <router-link to='/register'>Go to Registration Page</router-link>
</p>

<div class='container is-max-desktop has-background-white box-shadow block'>
  <div class='section'>
    <input type='hidden' name='id' value='0'>
    <div class='field is-horizontal'>
      <div class='field-label is-normal'>
        <label for='input-todo-title' class='label'>Task Title</lable>
      </div>
      <div class='field-body'>
        <div class='field is-expanded'>
          <div class='control'>
            <input class='input' id='input-todo-title' v-model="inputTodoTitle">
          </div>
        </div>
      </div>
    </div>

    <div class='field is-horizontal'>
      <div class='field-label is-normal'>
        <label for='input-todo-date' class='label'>Date</label>
      </div>
      <div class='field-body'>
        <div class='field'>
          <div class='control'>
            <input type='datetime-local' class='input' v-model="inputTodoDate">
          </div>
        </div>
      </div>
    </div>

    <div class='columns is-centered'>
      <div class='column is-2'>
        <button class='button is-primary is-rounded is-fullwidth' @click="createTodo">Create</button>
      </div>
      <div class='column is-2'>
        <button class='button is-rounded is-fullwidth' @click='clearTodoFields'>Clear</button>
      </div>
    </div>
  </div>
</div>

<div class='container is-max-desktop has-background-white box-shadow mb-6'>
  <div class='section'>
    <h1 class='title is-2 has-text-centered'>Upcoming Events</h1>
    <hr>

    <!--
    <div class='todo-task'>
      <div class='todo-content'>
        <p class='todo-title'>Cleaning House With Soap</p>
        <p class='todo-subtitle'>Thu. 05, Dec. 2023</p>
      </div>
      <div class='todo-right'>
        <button class='icon is-large trash'>
          <i class='fa fa-trash fa-xl'></i>
        </button>
        <button class='icon is-large completed'>
          <i class='fa fa-check fa-xl'></i>
        </button>
      </div>
    </div>
    -->

    <div :class='{ "todo-task-completed": todo.is_completed }' class='todo-task' v-for="todo in todos" :key="todo.id">
      <input type='hidden' :value='todo.id'>
      <div class='todo-content'>
        <p class='todo-title'>{{ todo.title }}</p>
        <p class='todo-subtitle'>{{ new Date (todo.date_epoch * 1000).toUTCString() }}</p>
      </div>
      <div class='todo-right'>
        <button class='button is-outlined is-danger' v-on:click="el => deleteTodo(el, todo.id)">
          <span class='icon'>
            <i class='fa fa-trash'></i>
          </span>
        </button>
        <button class='button is-outlined is-success' @click="updateTodo(todo)">
          <span class='icon is-large'>
            <i class='fa fa-check fa-xl'></i>
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<router-view></router-view>


<script>
  let rootVueApp = {}

  const componentLogin = {
    data() {
      return {

      }
    },
    template: `
      <div class='container'>
        <div class='columns is-centered'>
          <form class='column is-4 box section'>
            <div class='field is-horizontal'>
              <div class='field-label'>
                <label class='label' for='input-username'>Username</label>
              </div>
              <div class='field-body'>
                <div class='field'>
                  <div class='control is-expanded has-icons-left'>
                    <input class='input' v-model='inputUsername' id='input-username' type='text' placeholder='Username'>
                    <span class='icon is-left'>
                      <i class='fas fa-user'></i>
                    </span>
                  </div>
                  <p class='help'>Chose an unique username</p>
                </div>
              </div>
            </div>

            <div class='field is-horizontal'>
              <div class='field-label'>
                <label class='label' for='input-password'>Password</label>
              </div>
              <div class='field-body'>
                <div class='field'>
                  <div class='control is-expanded has-icons-left'>
                    <input v-model='inputPassword' type='password' class='input' placeholder='Password' id='input-password' />
                    <span class='icon is-left'>
                      <i class='fas fa-key'></i>
                    </span>
                    <p class='help'>Enter correct Password</p>
                  </div>
                </div>
              </div>
            </div>

            <button class='button is-primary is-fullwidth mt-5'>Login</button>
            <p class='has-text-centered mt-1'>Don't have an account ? <a>Register Now</a></p>
          </form>
        </div>
      </div>
    `,
  }

  const componentRegistration = {
    data() {
      return {
        inputUsername: 'Meriosa',
        inputPassword: 'secret',
      }
    },
    template: `
      <div class='container'>
        <div class='columns is-centered'>
          <form class='column is-4 box section'>
            <div class='field is-horizontal'>
              <div class='field-label'>
                <label class='label' for='input-username'>Username</label>
              </div>
              <div class='field-body'>
                <div class='field'>
                  <div class='control'>
                    <input class='input' v-model='inputUsername' id='input-username' type='text' placeholder='Username'>
                  </div>
                </div>
              </div>
            </div>

            <div class='field is-horizontal'>
              <div class='field-label'>
                <label class='label' for='input-password'>Password</label>
              </div>
              <div class='field-body'>
                <div class='field'>
                  <div class='control'>
                    <input v-model='inputPassword' type='password' class='input' placeholder='Password' id='input-password' />
                  </div>
                </div>
              </div>
            </div>

            <button class='button is-primary is-fullwidth mt-5' @click.prevent='registration'>Register</button>
          </form>
        </div>
      </div>
    `,
    methods: {
      registration: function () {
        console.log(`username: ${this.inputUsername} ::: password: ${this.inputPassword}`)
        console.log(`This : `, this)
        console.log(`This.$root : `, this.$root)
        console.log(`This.$data : `, this.$data)
        rootVueApp = this
      },
    }
  }

  routes = [
    {path: '/login', component: componentLogin},
    {path: '/register', component: componentRegistration},
  ]

  const router = VueRouter.createRouter({
    history: VueRouter.createWebHashHistory(),
    routes,
  })

  const pinia = Pinia.createPinia()

  const useVarStore = Pinia.defineStore('var', {
    state: () => ({count: 0, name: 'Eduardo'}),
    getters: {
      doubleCount(state) {return state.count * 2},
    },
    actions: {
      increment() {
        this.count++
      },
    },
  })

  const app = Vue.createApp({
    components: {
      'component-registration': componentRegistration,
      'component-login': componentLogin,
    },
    data() {
      return {
        userToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxfQ.jYyRJbb0WImFoUUdcslQQfwnXTHJzne-6tsPd8Hrw0I',
        inputUsername: 'Memosa',
        inputPassword: '',
        inputTodoTitle: '',
        inputTodoDate: new Date().toISOString().split(".")[0],
        todos: [],
      }
    },
    methods: {
      async deleteTodo(el, todoId) {
        console.log(`deleteTodo --> ${el}`, el)
        console.log('todo id ==> ', todoId)

        const url = `http://localhost:2200/api/v1/todo/${todoId}`
        let res = await fetch(url, {
          method: "DELETE",
          headers: {
            Authorization: `BEARER ${this.userToken}`
          }
        })
        let data = await res.json()
        console.log('DELETE ---> ', data)

        this.fetchAllTodos()
      },
      async updateTodo(todoProxy) {
        let todo = {
          "id": todoProxy.id,
          "title": todoProxy.title,
          "date_epoch": todoProxy.date_epoch,
          "is_completed": todoProxy.is_completed,
          "is_deleted": todoProxy.is_deleted,
          "user_id": todoProxy.user_id
        }

        todo.is_completed = !todo.is_completed
        const url = `http://localhost:2200/api/v1/todo/${todo.id}`

        let res = await fetch(url, {
          method: "PUT",
          headers: {
            Authorization: `BEARER ${this.userToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(todo),
        })

        let data = await res.json()
        console.log('updateTodo ---> ', data)

        this.fetchAllTodos()
      },
      async createTodo() {
        const title = this.inputTodoTitle
        const date_epoch = Date.parse(this.inputTodoDate) / 1000
        const url = `http://localhost:2200/api/v1/todo`

        let payload = {
          title,
          date_epoch,
        }

        let res = await fetch(url, {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
            Authorization: `BEARER ${this.userToken}`,
          },
          body: JSON.stringify(payload),
        })
        let data = await res.json()
        console.log('create todo : ', data)

        this.clearTodoFields()
        this.fetchAllTodos()
      },
      clearTodoFields() {
        this.inputTodoTitle = ''
        this.inputTodoDate = (new Date().toISOString()).split(".")[0]
      },
      async fetchAllTodos() {

        const url = `http://localhost:2200/api/v1/todo`
        let response = await fetch(url, {
          headers: {
            Authorization: "BEARER eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxfQ.jYyRJbb0WImFoUUdcslQQfwnXTHJzne-6tsPd8Hrw0I"
          }
        })
        let data = await response.json()
        this.todos = data.todos

        console.log(data)
      },
    },
    async mounted() {
      console.log('component mounted')

      this.fetchAllTodos()

      console.log('================ End mounted() hook ===============')
    },
    setup() {
      // const varStore = useVarStore()
      // const menuStore = useVarStore()
      // console.log('varStore: ', varStore)
      // console.log('menuStore: ', menuStore)
      // return {varStore}
    },
  })

  app.use(router)
  app.use(pinia)

  app.mount('body')
  const varStore = useVarStore()

  // let useVarStore = Pinia.defineStore('var', () => {
  //   const count = ref('0')
  //   const name = ref('Eduardo')

  //   const doubleCount = computed(() => count.value * 2)
  //   function increment() {
  //     count.value++
  //   }

  //   return {count, name, doubleCount, increment}
  // })

  console.log('Pinia : ', Pinia)
  console.log('Pinia : ', Pinia.createPinia)
  // console.log('Pinia useVarStore: ', useVarStore)
  // console.log('Pinia useVarStore (USED): ', useVarStore())
  // console.log(app)
  // console.log(app.$component)
  // console.log(app._component.template)
  console.log('===============================')
  console.log('store.count = ', varStore.count)
  console.log('varStore.name = ', varStore.name)
  console.log('varStore.increment() = ', varStore.increment())
  console.log('store.count = ', varStore.count)

</script>
